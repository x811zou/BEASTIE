---
title: "simulation"
author: "scarlett"
date: "4/30/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
```

## define path
```{R,echo=FALSE}
dfDir<-"/Users/scarlett/Documents/Allen_lab/github/BEASTIE/BEASTIE/"
```

## read file
I would probably just drop the datapoints with 0 or 1.
They really aren’t 0 or 1 (just means that we didn’t do enough simulations) and aren’t that important to nail down the relationship
 
```{R,echo=FALSE}
#df0<-read.delim(file.path(dfDir,paste0("lambda_type1error.txt",sep="")),header=TRUE,sep="\t")
BEASTIE<-read.delim(file.path(dfDir,paste0("lambda_type1error_BEASTIE3.txt",sep="")),header=TRUE,sep="\t")
BEASTIE_validation<-read.delim(file.path(dfDir,paste0("lambda_type1error_BEASTIE3_validation.txt",sep="")),header=TRUE,sep="\t")
iBEASTIE<-read.delim(file.path(dfDir,paste0("lambda_type1error_iBEASTIE2.txt",sep="")),header=TRUE,sep="\t")
iBEASTIE_validation<-read.delim(file.path(dfDir,paste0("lambda_type1error_iBEASTIE2_validation.txt",sep="")),header=TRUE,sep="\t")
het1<-BEASTIE%>%filter(hets==1)
iBEASTIE_2<-rbind(iBEASTIE,het1)
```

### save model
```{r}
data=iBEASTIE
validation_data=iBEASTIE_validation
cutoff=0.2
alphas=c(0.05,0.01,0.001)

df<-data%>%filter(type1error!=0)%>%filter(type1error!=1)
df2<-validation_data%>%filter(type1error!=0)%>%filter(type1error!=1)
df<-df%>%filter(type1error<cutoff)      # adding filtering
print(paste0("Filtering threshold is type 1 error < ",cutoff))
df<-df%>%mutate(t_type1error=type1error/(1-type1error))
df<-df%>%mutate(log_t_type1error=log(t_type1error))
df<-df%>%mutate(lambda_1=lambda-1)
df<-df%>%mutate(log_lambda=log(lambda))
df<-df%>%mutate(log_lambda_1=log(lambda_1))
df<-df%>%mutate(read_hets=read*hets)
#model2<-lm(log_t_type1error ~ log_lambda+read_hets,data=df)
model2<-lm(log_t_type1error ~ log_lambda_1+read_hets,data=df)
print(summary(model2))
print(paste0("BIC for model2: ",BIC(model2)))#1032.03189544736"
#save(model2, file = "/Users/scarlett/Documents/Allen_lab/github/BEASTIE/BEASTIE/LinearReg_iBEASTIE_fitted_model_lambda_loglambda.rds")
#saveRDS(model2, file = "/Users/scarlett/Documents/Allen_lab/github/BEASTIE/BEASTIE/LinearReg_iBEASTIE_fitted_model_lambda_loglambda.rds")
saveRDS(model2, file = "/Users/scarlett/Documents/Allen_lab/github/BEASTIE/BEASTIE/LinearReg_iBEASTIE_fitted_model_lambda_loglambda_version2.rds")
#load()
#predict(model2,newdata=newdf)
```
Call:
lm(formula = log_t_type1error ~ log_lambda + read_hets, data = df)

Residuals:
    Min      1Q  Median      3Q     Max 
-2.2583 -0.3881 -0.0442  0.4282  2.9002 

Coefficients:
              Estimate Std. Error t value Pr(>|t|)    
(Intercept)   3.919776   0.163085   24.04   <2e-16 ***
log_lambda  -20.710875   0.375699  -55.13   <2e-16 ***
read_hets    -0.007806   0.000197  -39.62   <2e-16 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 0.7774 on 430 degrees of freedom
Multiple R-squared:  0.8828,	Adjusted R-squared:  0.8822 
F-statistic:  1619 on 2 and 430 DF,  p-value: < 2.2e-16

## self-defined function
```{r}
manipulate_data <- function(data,validation_data,cutoff,alphas){
  df<-data%>%filter(type1error!=0)%>%filter(type1error!=1)
  df2<-validation_data%>%filter(type1error!=0)%>%filter(type1error!=1)
  df<-df%>%filter(type1error<cutoff)      # adding filtering
  print(paste0("Filtering threshold is type 1 error < ",cutoff))
  df<-df%>%mutate(t_type1error=type1error/(1-type1error))
  df<-df%>%mutate(log_t_type1error=log(t_type1error))
  df<-df%>%mutate(log_lambda=log(lambda))
  model1<-lm(log_t_type1error ~ read+log_lambda+read*hets,data=df)
  print(">>>>>>>>>>>>>>>>>>>>>>> MODEL1")
  print(summary(model1))
  df<-df%>%mutate(read_hets=read*hets)
  print(">>>>>>>>>>>>>>>>>>>>>>> MODEL2")
  model2<-lm(log_t_type1error ~ log_lambda+read_hets,data=df)
  print(summary(model2))
  print(paste0("BIC for model1: ",BIC(model1)))
  print(paste0("BIC for model2: ",BIC(model2)))
  #df<-df%>%rowwise%>%mutate(pred_lambda=Obtain_lambda_iBEASTIE2(type1error,read,hets))
  # model1
  df<-df%>%rowwise%>%mutate(pred_Y1=model1$coefficients[1]+
                            model1$coefficients[2]*read+
                            model1$coefficients[3]*log_lambda+
                              model1$coefficients[4]*hets+
                              model1$coefficients[5]*read*hets)
  df<-df%>%mutate(residual1=log_t_type1error-pred_Y1)
  df$model_fitted_values1<-model1$fitted.values
  df$residuals1<-model1$residuals
  df2<-df2%>%mutate(log_t_y=log(type1error/(1-type1error)))
  # model2
  df<-df%>%rowwise%>%mutate(pred_Y2=model2$coefficients[1]+model2$coefficients[2]*log_lambda+model2$coefficients[3]*read_hets)
  df<-df%>%rowwise%>%mutate(residual2=log_t_type1error-pred_Y2)
  df$model_fitted_values2<-model2$fitted.values
  df$residuals2<-model2$residuals
  df2<-df2%>%rowwise%>%
    mutate(log_lambda2=(log(alpha/(1-alpha)) -(model2$coefficients[1]+
                              model2$coefficients[3]*read*hets))/model2$coefficients[2])
  df2<-df2%>%rowwise%>%
    mutate(lambda2=exp(log_lambda2))
  predicted_lambda1=list()
  predicted_lambda2=list()
  for (alpha in alphas){
    #print(alpha)
    lambda1=exp((log(alpha/(1-alpha)) -(model1$coefficients[1]+
                            model1$coefficients[2]*validation_data$read[1]+
                              model1$coefficients[4]*validation_data$hets[1]+
                              model1$coefficients[5]*validation_data$read[1]*validation_data$hets[1]))/model1$coefficients[3])
    predicted_lambda1<-append(predicted_lambda1,lambda1[[1]][1])
    #print(lambda1)
    log_lambda2=(log(alpha/(1-alpha)) -(model2$coefficients[1]+
                              model2$coefficients[3]*validation_data$read[1]*validation_data$hets[1]))/model2$coefficients[2]
    lamda2=exp(log_lambda2[[1]][1])
    predicted_lambda2<-append(predicted_lambda2,lamda2)
    #print(lambda2)
  }
  predicted_lambda1<-as.data.frame(predicted_lambda1)
  colnames(predicted_lambda1)<-alphas
  predicted_lambda2<-as.data.frame(predicted_lambda2)
  colnames(predicted_lambda2)<-alphas
  predicted_lambda<-rbind(predicted_lambda1,predicted_lambda2)
  colnames(predicted_lambda)<-alphas
  rownames(predicted_lambda)<-c("model1","model2")
  print(predicted_lambda)
  return(list(df,df2,predicted_lambda))
}

#Obtain_lambda <- function(y,read,hets,intercept,read_cof,het_cof,lambda_cof){
#  log_t_y=log(y/(1-y))
#  intercept = 1.583e+01
#  read_cof = -6.481e-03
#  het_cof = 2.297e-02
#  lambda_cof = -1.335e+01
#  read_hets_cof=-6.049e-03
#  lambda = (log_t_y - (intercept+read_cof*read+het_cof*hets+read_hets_cof*read*hets))/lambda_cof
  #return(lambda)
#  print(lambda)
#}
#Obtain_lambda_BEASTIE3(0.05,100,10)
```

```{R}


calculate_RMSE <-function(real_y,pred_y){
  sum=0
  for (i in 1:length(real_y)){
    sum=sum+(real_y[i]-pred_y[i])^2
  }
  rmse=sqrt(sum/length(real_y))
  print(sum)
  print(paste0("RMSE is ",rmse))
  #return(rmse)
}
calculate_RMSE(df_BEASTIE$type1error,df_BEASTIE$model_fitted_values)

calculate_RMSE(df_iBEASTIE$type1error,df_iBEASTIE$model_fitted_values)
```
## BEASTIE3
```{R}
cutoff=0.2
alphas=c(0.05,0.01,0.001)
output1 <- manipulate_data(BEASTIE,BEASTIE_validation,cutoff,alphas)
```
```{r}
df1<-as.data.frame(as.list(output1[[1]]))
df2<-as.data.frame(as.list(output1[[2]]))
lambdas<-as.data.frame(as.list(output1[[3]]))

#lambdas<-df2%>%select(lambda1,lambda2)
#lambdas_V2<-rbind(lambdas$lambda1,lambdas$lambda2)
write.table(lambdas, file = "/Users/scarlett/Desktop/HARDAC/scarlett/software/cmdstan/examples/BEASTIE3/validation/lambdas.txt",row.names=FALSE,col.names = FALSE)
```

## iBEASTIE2
```{R}
cutoff=0.2
alphas=c(0.05,0.01,0.001)
output2 <- manipulate_data(iBEASTIE,iBEASTIE_validation,cutoff,alphas)
```

```{r}
df3_input<-as.data.frame(as.list(output2[[1]]))
df4_validation<-as.data.frame(as.list(output2[[2]]))
lambdas_i<-as.data.frame(as.list(output2[[3]]))
#lambdas<-df4%>%select(lambda1,lambda2)
#lambdas_V4<-rbind(lambdas$lambda1,lambdas$lambda2)
write.table(lambdas_i, file = "/Users/scarlett/Desktop/HARDAC/scarlett/software/cmdstan/examples/iBEASTIE2/validation/lambdas.txt",row.names=FALSE,col.names = FALSE)
```

```{R}
pal <- c("1.2"="#FF00CC","1.3"="gold","1.4" = "limegreen","1.5" = "black","1.6"= "blue","1.8"= "purple")

ggplot(data=df3,aes(x=lambda,y=log_t_type1error))+
  #geom_line(linetype="dashed",colour="grey")+
  geom_point(aes(colour = factor(lambda)))+
  scale_colour_manual(values=pal,limits=names(pal))+ theme_bw()+
  ggtitle("log transformed type1error VS lambda (filter for type1error<0.2) \nColor by lambda") +
  xlab("lambda") + ylab("log(transformed type1error)")
```

```{r}
ggplot(data=df3,aes(x=log_lambda,y=log_t_type1error))+
  geom_point(aes(colour = factor(lambda)))+
  scale_colour_manual(values=pal,limits=names(pal))+ theme_bw()+
  ggtitle("log transformed type1error VS lambda (filter for type1error<0.2) \nColor by lambda") +
  xlab("log lambda") + ylab("log(transformed type1error)")
```

```{R}
pal <- c("1.2"="#FF00CC","1.3"="gold","1.4" = "limegreen","1.5" = "black","1.6"= "blue","1.8"= "purple")

ggplot(data=df3,aes(x=model_fitted_values,y=residuals))+
  #geom_line(linetype="dashed",colour="grey")+
  geom_point(aes(colour = factor(lambda)))+
  scale_colour_manual(values=pal,limits=names(pal))+ theme_bw()+
  ggtitle("BEASTIE3 Fitted values VS Residuals (filter for type1error<0.2) \nColor by lambda") +
  xlab("fitted values (log(transformed type1error))") + ylab("residuals")+ 
  geom_vline(xintercept = log(0.05/0.95), linetype="dashed", color = "red", size=1,)+
  annotate(x=log(0.05/0.95),y=+Inf,label="log(0.05/0.95)",vjust=2,geom="label")+
    ylim(-8,4)
```
```{R}
pal <- c("1.2"="#FF00CC","1.3"="gold","1.4" = "limegreen","1.5" = "black","1.6"= "blue","1.8"= "purple")
ggplot(data=df_iBEASTIE,aes(x=model_fitted_values,y=residuals))+
  #geom_line(linetype="dashed",colour="grey")+
  geom_point(aes(colour = factor(lambda)))+
  scale_colour_manual(values=pal,limits=names(pal))+ theme_bw()+
  ggtitle("iBEASTIE2 Fitted values VS Residuals (filter for type1error<0.2) \nColor by lambda") +
  xlab("fitted values (log(transformed type1error))") + ylab("residuals")+ 
  geom_vline(xintercept = log(0.05/0.95), linetype="dashed", color = "red", size=1,)+
  annotate(x=log(0.05/0.95),y=+Inf,label="log(0.05/0.95)",vjust=2,geom="label")+
    ylim(-8,4)
```


```{R}
pal <- c("1"="red","2"="orange","3" = "gold","4"= "blue","5"= "purple",
         "6"="limegreen","7"="gold","8" = "azure","9"= "beige","10"= "black")
ggplot(data=df_iBEASTIE,aes(x=model_fitted_values,y=residuals))+
  #geom_line(linetype="dashed",colour="grey")+
  geom_point(aes(colour = factor(hets)))+
  scale_colour_manual(values=pal,limits=names(pal))+ theme_bw()+
  ggtitle("iBEASTIE2 Fitted values VS Residuals (filter for type1error<0.2) \nColor by #hets") +
  xlab("Fitted values (log(transformed type1error))") + ylab("residuals")+
    geom_vline(xintercept = log(0.05/0.95), linetype="dashed", color = "red", size=1,)+
  annotate(x=log(0.05/0.95),y=+Inf,label="log(0.05/0.95)",vjust=2,geom="label")+
      ylim(-8,3)
```

```{R}
pal <- c("1"="red","2"="orange","3" = "gold","4"= "blue","5"= "purple",
         "6"="limegreen","7"="gold","8" = "azure","9"= "beige","10"= "black")
ggplot(data=df_BEASTIE,aes(x=model_fitted_values,y=residuals))+
  #geom_line(linetype="dashed",colour="grey")+
  geom_point(aes(colour = factor(hets)))+
  scale_colour_manual(values=pal,limits=names(pal))+ theme_bw()+
  ggtitle("BEASTIE3 Fitted values VS Residuals (filter for type1error<0.2) \nColor by #hets") +
  xlab("Fitted values (log(transformed type1error))") + ylab("residuals")+
  geom_vline(xintercept = log(0.05/0.95), linetype="dashed", color = "red", size=1,)+
  annotate(x=log(0.05/0.95),y=+Inf,label="log(0.05/0.95)",vjust=2,geom="label")+
        ylim(-8,3)
```

```{R}
pal <- c("5"="red","10"="orange","20" = "gold","30"= "blue","40"= "purple",
         "50"="limegreen","60"="gold","70" = "azure4","80"= "beige","90"= "black","100"= "aquamarine2","110"= "bisque")

ggplot(data=df_BEASTIE,aes(x=model_fitted_values,y=residuals))+
  #geom_line(linetype="dashed",colour="grey")+
  geom_point(aes(colour = factor(read)))+
  scale_colour_manual(values=pal,limits=names(pal))+ theme_bw()+
  ggtitle("BEASTIE3 Fitted values VS Residuals (filter for type1error<0.2) \nColor by read depth") +
  xlab("fitted values (log(transformed type1error))") + ylab("residuals")+
  geom_vline(xintercept = log(0.05/0.95), linetype="dashed", color = "red", size=1,)+
  annotate(x=log(0.05/0.95),y=+Inf,label="log(0.05/0.95)",vjust=2,geom="label")+
          ylim(-8,3)
```

```{R}
pal <- c("5"="red","10"="orange","20" = "gold","30"= "blue","40"= "purple",
         "50"="limegreen","60"="gold","70" = "azure4","80"= "beige","90"= "black","100"= "aquamarine2","110"= "bisque")

ggplot(data=df_iBEASTIE,aes(x=model_fitted_values,y=residuals))+
  #geom_line(linetype="dashed",colour="grey")+
  geom_point(aes(colour = factor(read)))+
  scale_colour_manual(values=pal,limits=names(pal))+ theme_bw()+
  ggtitle("iBEASTIE2 Fitted values VS Residuals (filter for type1error<0.2) \nColor by read depth") +
  xlab("Fitted values (log(transformed type1error))") + ylab("residuals")+
  geom_vline(xintercept = log(0.05/0.95), linetype="dashed", color = "red", size=1,)+
  annotate(x=log(0.05/0.95),y=+Inf,label="log(0.05/0.95)",vjust=2,geom="label")+
          ylim(-8,3)
```








```{r}
myformat <- "Slope: %s\nP-value: %s"
pdf("Blautia_logAbundance.pdf",height=3,width=6)
ba <- ggplot(clinall,aes(x=ltime,y=bla))+geom_point()+facet_wrap(~inout,ncol=2)+
  geom_smooth(method = "lm", se=FALSE, color="red", formula = y ~ x)+
  stat_poly_eq(
    formula = y~x, output.type = "numeric",size=2.4,label.x=0.1,
    mapping = aes(label = 
                    sprintf(myformat,
                            c(formatC(stat(coef.ls)[[1]][[2, "Estimate"]]),
                              formatC(stat(coef.ls)[[2]][[2, "Estimate"]])),
                            c(formatC(stat(coef.ls)[[1]][[2, 4]]),
                              formatC(stat(coef.ls)[[2]][[2, 4]]))
                              )))+ 
  xlab("log(Days+1)")+ ylab("log(ASV Abundance)")+ylim(-10.7,1)
ba
dev.off()
```

```{r}
new.function <- function(a) {
   for(i in 1:a) {
      b <- i^2
      print(b)
   }
}

# Call the function new.function supplying 6 as an argument.
new.function(6)
```

```{r}
plot(df$lambda, df$log_t_type1error,main="lambda vs log(t_type1error)",
   xlab="lambda", ylab="log(t_type1error)", pch=19)
```

```{r}
plot(df$lambda, df$type1error,main="lambda vs type1error",
   xlab="lambda", ylab="type 1 error", pch=19)
```

